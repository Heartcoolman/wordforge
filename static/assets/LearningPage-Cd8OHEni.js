import{g as ce,h as $,j as C,b as f,u as de,o as ue,k as me,i as s,c as a,m as U,S as E,d as ge,C as Y,B,F as fe,e as he,l as xe,n as pe,f as re,t as m,p as we}from"./index-6s_4JTtF.js";import{P as ve}from"./Progress-DU77zIq3.js";import{l as P}from"./learning-PjntfU40.js";import{r as _e}from"./records-C70kufFG.js";function Se(){const y=$.get(C.LEARNING_MODE,"word-to-meaning"),[e,n]=f(y),[h,R]=f($.getString(C.LEARNING_SESSION_ID)||null);function z(){const g=e()==="word-to-meaning"?"meaning-to-word":"word-to-meaning";n(g),$.set(C.LEARNING_MODE,g)}function O(g){n(g),$.set(C.LEARNING_MODE,g)}function D(g){R(g),$.setString(C.LEARNING_SESSION_ID,g)}function _(){R(null),$.remove(C.LEARNING_SESSION_ID),$.remove(C.LEARNING_QUEUE)}return{mode:e,setMode:O,toggleMode:z,sessionId:h,startSession:D,clearSession:_}}const N=ce(Se),be=2;function se(y){const e=[...y];for(let n=e.length-1;n>0;n--){const h=Math.floor(Math.random()*(n+1));[e[n],e[h]]=[e[h],e[n]]}return e}function $e(y=5){let e=[],n=[],h=y;const[R,z]=f(0),[O,D]=f(0);function _(){z(e.length),D(n.length)}function g(){$.set(C.LEARNING_QUEUE,{active:e,mastered:n,batchSize:h})}function j(){const r=$.get(C.LEARNING_QUEUE,null);r&&(e=r.active??[],n=r.mastered??[],h=r.batchSize??h),_()}return j(),{activeCount:R,masteredCount:O,loadWords(r){const w=new Set([...e.map(t=>t.word.id),...n.map(t=>t.word.id)]);for(const t of r)w.has(t.id)||e.push({word:t,correctCount:0,errorCount:0,lastShown:0});g(),_()},addWords(r){const w=new Set([...e.map(t=>t.word.id),...n.map(t=>t.word.id)]);for(const t of r)w.has(t.id)||e.push({word:t,correctCount:0,errorCount:0,lastShown:0});g(),_()},pickNext(){if(e.length===0)return null;const r=e.filter(t=>t.errorCount>0);return r.length>0?(r.sort((t,v)=>t.lastShown-v.lastShown),r[0]):[...e].sort((t,v)=>t.lastShown-v.lastShown)[0]},recordAnswer(r,w){const t=e.find(v=>v.word.id===r);if(!t)return{mastered:!1};if(t.lastShown=Date.now(),w){if(t.correctCount++,t.errorCount=0,t.correctCount>=be)return e=e.filter(v=>v.word.id!==r),n.push(t),g(),_(),{mastered:!0}}else t.correctCount=0,t.errorCount++;return g(),_(),{mastered:!1}},generateOptions(r,w){const t=[...e,...n],v=w==="word-to-meaning"?r.word.meaning:r.word.text,G=se(t.filter(A=>A.word.id!==r.word.id)).slice(0,3).map(A=>w==="word-to-meaning"?A.word.meaning:A.word.text);for(;G.length<3;)G.push(w==="word-to-meaning"?"(无释义)":"(unknown)");return se([v,...G])},needsMoreWords(){return e.length<h},getAllWordIds(){return[...e.map(r=>r.word.id),...n.map(r=>r.word.id)]},getMasteredWordIds(){return n.map(r=>r.word.id)},getActiveCount(){return e.length},getMasteredCount(){return n.length},setBatchSize(r){h=r},reset(){e=[],n=[],$.remove(C.LEARNING_QUEUE),_()}}}var Ce=m('<div class=space-y-1><div class="flex justify-between text-xs text-content-secondary"><span>已掌握 <!>/</span><span>第 <!> 题 | 正确率 <!>%'),ye=m('<div class="flex flex-col items-center justify-center py-20"><p class="mt-4 text-content-secondary">正在准备学习内容...'),Ee=m('<svg class="w-16 h-16 mx-auto text-content-tertiary mb-4"fill=none viewBox="0 0 24 24"stroke=currentColor stroke-width=1.5><path stroke-linecap=round stroke-linejoin=round d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">'),Ie=m('<h2 class="text-xl font-semibold text-content mb-2">准备开始学习'),ke=m('<p class="text-content-secondary mb-6">请先前往词库添加单词，或在设置中选择词书'),oe=m('<div class="flex gap-3 justify-center">'),Me=m('<div class="w-16 h-16 mx-auto mb-4 rounded-full bg-success-light flex items-center justify-center"><svg class="w-8 h-8 text-success"fill=none viewBox="0 0 24 24"stroke=currentColor stroke-width=2><path stroke-linecap=round stroke-linejoin=round d="M5 13l4 4L19 7">'),Ne=m('<h2 class="text-2xl font-bold text-content mb-2">学习完成!'),Ae=m('<div class="grid grid-cols-3 gap-4 my-6 max-w-sm mx-auto"><div><p class="text-2xl font-bold text-accent"></p><p class="text-xs text-content-secondary">总答题数</p></div><div><p class="text-2xl font-bold text-success">%</p><p class="text-xs text-content-secondary">正确率</p></div><div><p class="text-2xl font-bold text-warning"></p><p class="text-xs text-content-secondary">已掌握'),We=m('<div class="max-w-2xl mx-auto space-y-6 animate-fade-in-up"><div class="flex items-center justify-between"><h1 class="text-2xl font-bold text-content">单词学习</h1><div class="flex items-center gap-2"><button class="text-xs px-3 py-1.5 rounded-full bg-surface-tertiary text-content-secondary hover:text-content transition-colors cursor-pointer">'),Le=m("<p class=text-content-tertiary>"),Re=m('<div><p class="text-3xl font-bold text-content mb-2">'),ze=m('<div class=text-center><p class="text-sm text-error">正确答案: <span class=font-semibold>'),De=m('<div class=space-y-6><div class="grid grid-cols-1 sm:grid-cols-2 gap-3">'),Ge=m('<div><p class="text-lg text-content-secondary mb-2">选择对应的单词</p><p class="text-2xl font-bold text-content">'),Oe=m('<button><span class="absolute top-2 left-3 text-xs font-mono text-content-tertiary"></span><p class="text-sm font-medium text-content pl-5">');function Be(){const y=de(),[e,n]=f("loading"),[h,R]=f(null),[z,O]=f([]),[D,_]=f(null),[g,j]=f(!1),[r,w]=f(0),[t,v]=f(0),[G,A]=f(0),[q,ie]=f(10),[F,J]=f(""),d=$e(5);async function V(){n("loading");try{const i=await P.createSession();J(i.sessionId),N.startSession(i.sessionId);const c=await P.getStudyWords();if(c.strategy?.batchSize&&d.setBatchSize(c.strategy.batchSize),ie(c.words.length||10),c.words.length===0){re.toast.warning("暂无可学习的单词","请先添加单词或选择词书"),n("setup");return}d.loadWords(c.words),H()}catch(i){re.toast.error("加载失败",i instanceof Error?i.message:""),n("setup")}}function X(i){if(e()!=="quiz")return;const c=z(),W=parseInt(i.key);W>=1&&W<=4&&c[W-1]&&ee(c[W-1])}ue(()=>{V(),document.addEventListener("keydown",X)}),me(()=>{document.removeEventListener("keydown",X),F()&&P.syncProgress({sessionId:F(),totalQuestions:t()}).catch(()=>{})});function H(){const i=d.pickNext();if(!i){d.needsMoreWords()?Z():n("summary");return}R(i);const c=N.mode();O(d.generateOptions(i,c)),_(null),j(!1),w(Date.now()),n("quiz")}async function Z(){try{const i=await P.getNextWords({excludeWordIds:d.getAllWordIds(),masteredWordIds:d.getMasteredWordIds()});if(i.words.length===0){n("summary");return}d.addWords(i.words),H()}catch{n("summary")}}async function ee(i){if(D())return;const c=h();if(!c)return;const K=N.mode()==="word-to-meaning"?c.word.meaning:c.word.text,I=i===K;_(i),j(I),n("feedback"),v(u=>u+1),I&&A(u=>u+1);const o=Date.now()-r(),S=d.recordAnswer(c.word.id,I);if(_e.create({wordId:c.word.id,isCorrect:I,responseTimeMs:o,sessionId:F()||void 0}).catch(()=>{}),S.mastered&&d.masteredCount()>=q()){setTimeout(()=>n("summary"),1500);return}setTimeout(()=>{d.needsMoreWords()&&d.activeCount()===0?Z():H()},I?1e3:2e3)}function le(){d.reset(),N.clearSession(),v(0),A(0),J(""),V()}return(()=>{var i=We(),c=i.firstChild,W=c.firstChild,K=W.nextSibling,I=K.firstChild;return I.$$click=()=>N.toggleMode(),s(I,()=>N.mode()==="word-to-meaning"?"英 → 中":"中 → 英"),s(i,a(E,{get when(){return U(()=>e()!=="setup")()&&e()!=="loading"},get children(){var o=Ce(),S=o.firstChild,u=S.firstChild,L=u.firstChild,l=L.nextSibling;l.nextSibling;var x=u.nextSibling,p=x.firstChild,b=p.nextSibling,k=b.nextSibling,M=k.nextSibling;return M.nextSibling,s(u,()=>d.masteredCount(),l),s(u,q,null),s(x,t,b),s(x,(()=>{var Q=U(()=>t()>0);return()=>Q()?Math.round(G()/t()*100):0})(),M),s(o,a(ve,{get value(){return d.masteredCount()},get max(){return q()},color:"success"}),null),o}}),null),s(i,a(E,{get when(){return e()==="loading"},get children(){var o=ye(),S=o.firstChild;return s(o,a(ge,{size:"lg"}),S),o}}),null),s(i,a(E,{get when(){return e()==="setup"},get children(){return a(Y,{variant:"elevated",class:"text-center py-12",get children(){return[Ee(),Ie(),ke(),(()=>{var o=oe();return s(o,a(B,{onClick:()=>y("/vocabulary"),variant:"outline",children:"管理词库"}),null),s(o,a(B,{onClick:()=>y("/wordbooks"),children:"选择词书"}),null),o})()]}})}}),null),s(i,a(E,{get when(){return e()==="quiz"||e()==="feedback"},get children(){return a(E,{get when(){return h()},children:o=>{const S=()=>N.mode()==="word-to-meaning"?o().word.meaning:o().word.text;return(()=>{var u=De(),L=u.firstChild;return s(u,a(Y,{variant:"glass",class:"text-center py-10",get children(){return a(E,{get when(){return N.mode()==="word-to-meaning"},get fallback(){return(()=>{var l=Ge(),x=l.firstChild,p=x.nextSibling;return s(p,()=>o().word.meaning),l})()},get children(){var l=Re(),x=l.firstChild;return s(x,()=>o().word.text),s(l,a(E,{get when(){return o().word.pronunciation},get children(){var p=Le();return s(p,()=>o().word.pronunciation),p}}),null),l}})}}),L),s(L,a(fe,{get each(){return z()},children:(l,x)=>{const p=()=>D()===l,b=()=>l===S(),k=()=>e()==="feedback";return(()=>{var M=Oe(),Q=M.firstChild,ae=Q.nextSibling;return M.$$click=()=>ee(l),s(Q,()=>x()+1),s(ae,l),he(T=>{var te=e()==="feedback",ne=xe("relative p-4 rounded-xl border-2 text-left transition-all duration-200 cursor-pointer","hover:shadow-md active:scale-[0.98]",!k()&&"border-border hover:border-accent bg-surface-elevated",k()&&b()&&"border-success bg-success-light animate-pulse-success",k()&&p()&&!b()&&"border-error bg-error-light animate-shake",k()&&!p()&&!b()&&"border-border opacity-50","disabled:cursor-default");return te!==T.e&&(M.disabled=T.e=te),ne!==T.t&&pe(M,T.t=ne),T},{e:void 0,t:void 0}),M})()}})),s(u,a(E,{get when(){return U(()=>e()==="feedback")()&&!g()},get children(){var l=ze(),x=l.firstChild,p=x.firstChild,b=p.nextSibling;return s(b,S),l}}),null),u})()}})}}),null),s(i,a(E,{get when(){return e()==="summary"},get children(){return a(Y,{variant:"elevated",class:"text-center py-10 animate-scale-in",get children(){return[Me(),Ne(),(()=>{var o=Ae(),S=o.firstChild,u=S.firstChild,L=S.nextSibling,l=L.firstChild,x=l.firstChild,p=L.nextSibling,b=p.firstChild;return s(u,t),s(l,(()=>{var k=U(()=>t()>0);return()=>k()?Math.round(G()/t()*100):0})(),x),s(b,()=>d.masteredCount()),o})(),(()=>{var o=oe();return s(o,a(B,{onClick:()=>y("/"),variant:"outline",children:"返回首页"}),null),s(o,a(B,{onClick:le,children:"再学一组"}),null),o})()]}})}}),null),i})()}we(["click"]);export{Be as default};
